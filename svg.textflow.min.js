// svg.textflow.js 0.1 - Copyright (c) 2013 Wout Fierens - Licensed under the MIT license
SVG.Textflow=function(){this.constructor.call(this,SVG.create("text"));this.styles={"font-size":16,"font-family":"Helvetica, Arial, sans-serif","text-anchor":"start"};this._x=0;this._y=0;this._width=100;this._height=100;this._leading=1.2};SVG.Textflow.prototype=new SVG.Text;SVG.extend(SVG.Textflow,{x:function(e,t){if(e==null)return t?this.attr("x"):this.bbox().x;this._x=e;return this.attr("x",e)},y:function(e){if(e!=null)this._y=e/=this.trans.scaleY;return this.attr("y",e)},text:function(e){if(e==null)return this.content;this.content=SVG.regex.test(e,"isBlank")?"text":e;this.attr("x",0).attr(this.styles);return this.attr("textLength",1).attr("textLength",null)},size:function(e,t){this._width=e;this._height=t==null?e:t;return this.build().move(this._x,this._y)},build:function(){var e,t,n,r,i,s,o,u,a=[],f=(this.content||"").split("\n"),l=this.styles["font-size"],c={dy:this._leading*l,x:0,"font-size":l,style:"font-size:"+l+";"};this.clear();this.transform("y",0);r=this.parent.text("well").attr(this.styles).move(-999999,-999999);e=f.length;while(e--){s="";o=f.shift().split(" ");t=o.length;while(t--){u=o.shift();r.text(s+u).attr(c);n=r.bbox();if(n.width+l/2<=this._width){s+=(s.length>0?" ":"")+u}else{a.push(s);s=u}}a.push(s)}n=this.bbox();this.transform("y",this._y-n.y);e=a.length;while(e--){if(this.bbox().height>this._height){if(i)this.node.removeChild(i.node);break}i=(new SVG.TSpan).attr("xml:space","preserve","http://www.w3.org/XML/1998/namespace");this.node.appendChild(i.node);this.lines.push(i);s=a.shift();i.text(s==""?" ":s).attr(c)}if(this.bbox().height>this._height&&i)this.node.removeChild(i.node);r.remove();return this},rebuild:function(e,t){if(["font-size","font-family"].indexOf(e)>-1)this.build().move(this._x,this.attr("y"));else if(e=="text-anchor")this.transform("x",t=="start"?0:t=="middle"?this._width/2:this._width);else if(e=="x")for(var n=this.lines.length-1;n>=0;n--)this.lines[n].attr(e,t);return this}});SVG.extend(SVG.Container,{textflow:function(e,t,n){return this.put(new SVG.Textflow).size(t==null?100:t,n==null?100:n).text(e)}})