SVG.Textflow=function(){this.constructor.call(this,SVG.create("text"));this.styles={"font-size":16,"font-family":"Helvetica, Arial, sans-serif","text-anchor":"start"};this._x=0;this._y=0;this._width=100;this._height=100;this._leading=1.2;this.type="textflow";};SVG.Textflow.prototype=new SVG.Text;SVG.extend(SVG.Textflow,{x:function(b,c){if(b==null){return c?this.attr("x"):this.bbox().x;}this._x=b;return this.attr("x",b);},y:function(a){if(a!=null){this._y=a/=this.trans.scaleY;}return this.attr("y",a);},text:function(a){if(a==null){return this.content;}this.content=SVG.regex.isBlank.test(a)?"text":a;return this.attr("x",0).attr(this.styles);},size:function(a,b){this._width=a;this._height=b==null?a:b;return this.build().move(this._x,this._y);},build:function(){var c,g,d,j,h,n,e,b,k=this,m=[],f=(this.content||"").split("\n"),l=this.styles["font-size"],a={dy:this._leading*l,x:0,"font-size":l,style:"font-size:"+l+";"};this.clear();this.data("overflow",null);this.transform("y",0);j=this.parent.text("well").attr(this.styles).move(-999999,-999999);c=f.length;while(c--){n="";e=f.shift().split(" ");g=e.length;while(g--){b=e.shift();j.text(n+b).attr(a);d=j.bbox();if(d.width+l/2<=this._width){n+=(n.length>0?" ":"")+b;}else{m.push(n);n=b;}}m.push(n);}c=m.length;while(c--){if(this.bbox().height>this._height){if(h){this.node.removeChild(h.node);}m.unshift(h.node.textContent);break;}h=new SVG.TSpan().attr("xml:space","preserve","http://www.w3.org/XML/1998/namespace");this.node.appendChild(h.node);this.lines.members.push(h);n=m.shift();h.text(n==""?" ":n).attr(a);}if(this.bbox().height>this._height&&h){this.node.removeChild(h.node);m.unshift(h.node.textContent);}this.transform("y",-l*this._base);this.data("overflow",m.join(" "),true);j.remove();this.style("fill",new SVG.Color(this.attr("fill")).brightness()>0.5?"#999":"#333");setTimeout(function(){k.style("fill",null);},1);return this;},rebuild:function(b,c){if(["font-size","font-family","leading"].indexOf(b)>-1){this.build().move(this._x,this.attr("y"));}else{if(b=="text-anchor"){this.transform("x",c=="start"?0:c=="middle"?this._width/2:this._width);}else{if(b=="x"){for(var d=this.lines.members.length-1;d>=0;d--){this.lines.members[d].attr(b,c);}}}}return this;}});SVG.extend(SVG.Container,{textflow:function(c,a,b){return this.put(new SVG.Textflow).size(a==null?100:a,b==null?100:b).text(c);}});