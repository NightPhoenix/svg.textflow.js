// svg.textflow.js 0.7 - Copyright (c) 2013 Wout Fierens - Licensed under the MIT license
SVG.Textflow=function(){this.constructor.call(this,SVG.create("text"));this.styles={"font-size":16,"font-family":"Helvetica, Arial, sans-serif","text-anchor":"start"};this._x=0;this._y=0;this._width=100;this._height=100;this._leading=1.2;this.type="textflow"};SVG.Textflow.prototype=new SVG.Text;SVG.extend(SVG.Textflow,{x:function(e,t){if(e==null)return t?this.attr("x"):this.bbox().x;this._x=e;return this.attr("x",e)},y:function(e){if(e!=null)this._y=e/=this.trans.scaleY;return this.attr("y",e)},text:function(e){if(e==null)return this.content;this.content=SVG.regex.test(e,"isBlank")?"text":e;return this.attr("x",0).attr(this.styles)},size:function(e,t){this._width=e;this._height=t==null?e:t;return this.build().move(this._x,this._y)},build:function(){var e,t,n,r,i,s,o,u,a=this,f=[],l=(this.content||"").split("\n"),c=this.styles["font-size"],h={dy:this._leading*c,x:0,"font-size":c,style:"font-size:"+c+";"};this.clear();this.data("overflow",null);this.transform("y",0);r=this.parent.text("well").attr(this.styles).move(-999999,-999999);e=l.length;while(e--){s="";o=l.shift().split(" ");t=o.length;while(t--){u=o.shift();r.text(s+u).attr(h);n=r.bbox();if(n.width+c/2<=this._width){s+=(s.length>0?" ":"")+u}else{f.push(s);s=u}}f.push(s)}e=f.length;while(e--){if(this.bbox().height>this._height){if(i)this.node.removeChild(i.node);f.unshift(i.node.textContent);break}i=(new SVG.TSpan).attr("xml:space","preserve","http://www.w3.org/XML/1998/namespace");this.node.appendChild(i.node);this.lines.push(i);s=f.shift();i.text(s==""?" ":s).attr(h)}if(this.bbox().height>this._height&&i){this.node.removeChild(i.node);f.unshift(i.node.textContent)}this.transform("y",-c*this._base);this.data("overflow",f.join(" "),true);r.remove();this.style("fill",(new SVG.Color(this.attr("fill"))).brightness()>.5?"#999":"#333");setTimeout(function(){a.style("fill",null)},1);return this},rebuild:function(e,t){if(["font-size","font-family","leading"].indexOf(e)>-1)this.build().move(this._x,this.attr("y"));else if(e=="text-anchor")this.transform("x",t=="start"?0:t=="middle"?this._width/2:this._width);else if(e=="x")for(var n=this.lines.length-1;n>=0;n--)this.lines[n].attr(e,t);return this}});SVG.extend(SVG.Container,{textflow:function(e,t,n){return this.put(new SVG.Textflow).size(t==null?100:t,n==null?100:n).text(e)}})